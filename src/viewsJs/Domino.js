import * as THREE from 'three';
import * as CANNON from 'cannon-es';
import {PWorld, PSphere, PJumpSphere, PPolyhedron, PBox } from '../PWorld/PObjects.js'
import { getMeshTransparentMaterial03, getDiceCubeMaterial, getEarthMaterial, getMeshWireMaterial } from '../PWorld/Scene/MeshMaterials.js'
import { BoxComposer } from '../PWorld/Tools/Composer.js';
import { rand } from 'three/tsl';


const world = new PWorld({
    cameraPosition: [100, 20, 20],
    gravity: [0, -100, 0],
    useGround: true,
    ground: {
        size: [100, 100, 5, 100],
        color: 0x22ff44,
        type: "cylinder",
        meshMaterialFn: getMeshTransparentMaterial03
    },
    useWorldRadius: true,    
    worldRadius: 100,
    orbitControlDistance: [1, 200]
});

const boxComposer = new BoxComposer({
    // position: [0, 2.5, 0],
    color: 0x0000ff,
    // itemMass: 200,
    data: [[[2, 15, 1], [-4.641703440088088, 7.5, 31.65957313764316], [0, 0.032926337980620064, 0, 0.9994577811329431]], [[2, 15, 1], [-3.6610307816310215, 7.5, 39.31320837715818], [0, 0.07845574670888986, 0, 0.9969175973009758]], [[2, 15, 1], [-2.441381779781289, 7.5, 45.552461479990264], [0, 0.0839763964226136, 0, 0.9964677440057315]], [[2, 15, 1], [-1.7529966034108841, 7.5, 50.553219693073004], [0, 0.030684004366122473, 0, 0.999529135081144]], [[2, 15, 1], [-1.8580410675154022, 7.5, 55.04464756965844], [0, -0.028781900672996526, 0, 0.9995857152809107]], [[2, 15, 1], [-2.280260954735587, 7.5, 59.70148537024037], [0, -0.015045627640516462, 0, 0.9998868081382527]], [[2, 15, 1], [-2.145312290674053, 7.5, 64.58807360828183], [0, 0.07660439202744108, 0, 0.9970615663649393]], [[2, 15, 1], [-0.8298823081491484, 7.5, 69.08463249991401], [0, 0.2218587891608707, 0, 0.9750788058777979]], [[2, 15, 1], [1.5811077399354834, 7.5, 72.3530263283196], [0, 0.3969976031127342, 0, 0.917819646293728]], [[2, 15, 1], [4.381518006015637, 7.5, 73.98167592014634], [0, 0.569745282099034, 0, 0.8218213391765221]], [[2, 15, 1], [6.806671165746915, 7.5, 74.31043080122461], [0, 0.6901493922274174, 0, 0.7236669236659407]], [[2, 15, 1], [8.635363194521124, 7.5, 74.18348228829817], [0, 0.7061011743325019, 0, 0.7081109599534962]], [[2, 15, 1], [10.364617681277288, 7.5, 74.32054346256528], [0, 0.6543087825159227, 0, 0.7562274903245261]], [[2, 15, 1], [12.821272914733514, 7.5, 74.79156522773448], [0, 0.6671249994417694, 0, 0.744945793410379]], [[2, 15, 1], [16.510318823083285, 7.5, 75.00000000000001], [-0, 0.732132603537383, 0, 0.6811621325628526]], [[2, 15, 1], [21.203775260852574, 7.5, 74.1861479205699], [-0, 0.8041974087571396, 0, 0.5943622866133939]], [[2, 15, 1], [26.088125615990833, 7.5, 72.05976967532048], [-0, 0.8625071275388337, 0, 0.506044913959927]], [[2, 15, 1], [30.356573965144296, 7.5, 69.07113217433574], [-0, 0.8976223183272599, 0, 0.44076544061529527]], [[2, 15, 1], [33.788611714284414, 7.5, 66.10932952684189], [-0, 0.9013246470037196, 0, 0.4331441800412654]], [[2, 15, 1], [36.8694558115872, 7.5, 63.85977071308461], [-0, 0.8660254037844385, 0, 0.5000000000000003]], [[2, 15, 1], [40.35805294025957, 7.5, 62.31646086659971], [-0, 0.825776186918976, 0, 0.5639979513416306]], [[2, 15, 1], [44.639068148555324, 7.5, 60.82513031284413], [-0, 0.8305252278467171, 0, 0.5569810103676414]], [[2, 15, 1], [49.361528321687686, 7.5, 58.622864358227844], [-0, 0.8695013147146246, 0, 0.49393062641381097]], [[2, 15, 1], [53.64520107769738, 7.5, 55.45608199231927], [-0, 0.9168315436371771, 0, 0.39927424233460235]], [[2, 15, 1], [56.696745872291274, 7.5, 51.798355525370475], [-0, 0.9559700126641052, 0, 0.293464367320787]], [[2, 15, 1], [58.360759018652175, 7.5, 48.4993306668798], [-0, 0.978704481256627, 0, 0.20527430031106197]], [[2, 15, 1], [59.181169821008375, 7.5, 46.13629394378211], [-0, 0.9820666089191517, 0, 0.1885342824157949]], [[2, 15, 1], [59.927098605598616, 7.5, 44.57018504150951], [-0, 0.9662926671841637, 0, 0.25744607463722413]], [[2, 15, 1], [60.95138525715268, 7.5, 43.04996554535615], [-0, 0.9717886358869486, 0, 0.23585344424236074]], [[2, 15, 1], [61.8792517583864, 7.5, 40.78534386042163], [-0, 0.9965907981485356, 0, 0.08250321839583193]], [[2, 15, 1], [61.86900497104135, 7.5, 37.54579263306408], [-0, -0.993353931339184, 0, 0.11509981360970539]], [[2, 15, 1], [60.24398791011213, 7.5, 33.82361708894853], [-0, -0.9553724111624031, 0, 0.295404055472731]], [[2, 15, 1], [57.00756867160831, 7.5, 30.436141861366167], [-0, -0.9017828416228615, 0, 0.4321894336452445]], [[2, 15, 1], [52.843133451660925, 7.5, 27.875978771061384], [-0, -0.8584045629364054, 0, 0.5129732998216954]], [[2, 15, 1], [48.599083671443246, 7.5, 25.913213019086108], [-0, -0.8512756723568093, 0, 0.5247187147924707]], [[2, 15, 1], [44.656870799002405, 7.5, 23.758470255234823], [-0, -0.8809596249860201, 0, 0.4731914402696768]], [[2, 15, 1], [40.67027973647425, 7.5, 20.661932098368023], [-0, -0.9049545785720391, 0, 0.42550817938260943]], [[2, 15, 1], [35.87675254970566, 7.5, 16.486058527649774], [-0, -0.9025838380968352, 0, 0.4305141289277114]], [[2, 15, 1], [29.738846330214404, 7.5, 11.809953472871628], [-0, -0.8820189974614663, 0, 0.471213845421662]], [[2, 15, 1], [22.418361720178297, 7.5, 7.485373388668204], [-0, -0.8549215039369097, 0, 0.5187573827004802]], [[2, 15, 1], [14.714933520199057, 7.5, 3.9882902978660573], [-0, -0.8353147540414604, 0, 0.5497720088187964]], [[2, 15, 1], [7.514972623684912, 7.5, 1.0678068962754155], [-0, -0.8386063740656214, 0, 0.5447378721701944]], [[2, 15, 1], [1.1755021061035678, 7.5, -2.036029372175659], [-0, -0.8660254037844387, 0, 0.49999999999999994]], [[2, 15, 1], [-4.682234210353244, 7.5, -5.9742537527180595], [-0, -0.8910600227356792, 0, 0.4538854876312865]], [[2, 15, 1], [-10.811427475718615, 7.5, -10.74936109455858], [-0, -0.8937739029474103, 0, 0.4485177927464563]], [[2, 15, 1], [-17.69170437148789, 7.5, -15.672184066568958], [-0, -0.8767178237877968, 0, 0.4810050493007218]], [[2, 15, 1], [-25.09714289012634, 7.5, -19.849619664771517], [-0, -0.8490926594808459, 0, 0.5282439357112811]], [[2, 15, 1], [-32.21572176807469, 7.5, -22.827149849508388], [-0, -0.8241280913879447, 0, 0.5664034683732643]], [[2, 15, 1], [-38.22889795669301, 7.5, -24.890529381622212], [-0, -0.8209781821494249, 0, 0.5709595646231227]], [[2, 15, 1], [-42.903874195591555, 7.5, -26.79474943783817], [-0, -0.8502756206198966, 0, 0.526337694811468]], [[2, 15, 1], [-46.74104260392787, 7.5, -29.1314345505723], [-0, -0.8800575730298058, 0, 0.47486700048844005]], [[2, 15, 1], [-50.56287249692538, 7.5, -31.82550659917896], [-0, -0.8734501905769223, 0, 0.486913508316557]], [[2, 15, 1], [-54.86225638093427, 7.5, -34.15193174691562], [-0, -0.825178449595421, 0, 0.5648721327196955]], [[2, 15, 1], [-59.41410560196301, 7.5, -35.261015410965435], [-0, -0.7335136220015335, 0, 0.679674750405068]], [[2, 15, 1], [-63.45011271097681, 7.5, -34.807233695255476], [0, -0.5963563282264488, 0, 0.8027198326840244]], [[2, 15, 1], [-66.26076976440201, 7.5, -33.19633205972469], [0, -0.42684551604949955, 0, 0.9043245575723554]], [[2, 15, 1], [-67.75805642289959, 7.5, -31.260465255868436], [0, -0.28163924365953324, 0, 0.9595203679083035]], [[2, 15, 1], [-68.56246180011975, 7.5, -29.613297246788633], [0, -0.2601914928516594, 0, 0.96555703459072]], [[2, 15, 1], [-69.54578750228563, 7.5, -28.18424951878315], [0, -0.32775782640322787, 0, 0.9447617727403197]], [[2, 15, 1], [-71.18203193338567, 7.5, -26.292234560854677], [0, -0.3115794818148597, 0, 0.9502200937214407]], [[2, 15, 1], [-73.20706469537454, 7.5, -23.201644474629504], [0, -0.22383740912672256, 0, 0.9746264998836407]], [[2, 15, 1], [-74.84897633854992, 7.5, -18.730065928250628], [0, -0.11263413488003754, 0, 0.9936365289479979]], [[2, 15, 1], [-75.44965393767849, 7.5, -13.436905317092643], [0, -0.006994187175790985, 0, 0.9999755403737384]], [[2, 15, 1], [-74.99564211369959, 7.5, -8.246001861491598], [0, 0.06709709048054277, 0, 0.9977464509829368]], [[2, 15, 1], [-74.14666465454395, 7.5, -3.7928686602421586], [0, 0.07554846008474256, 0, 0.9971421313828958]], [[2, 15, 1], [-73.73891162317437, 7.5, 2.128483938714214E-14], [0, 0, 0, 1]], [[2, 15, 1], [-74.14666465454395, 7.5, 3.792868660242193], [0, -0.0755484600847425, 0, 0.9971421313828958]], [[2, 15, 1], [-74.99564211369959, 7.5, 8.246001861491646], [0, -0.06709709048054273, 0, 0.9977464509829368]], [[2, 15, 1], [-75.44965393767849, 7.5, 13.436905317092682], [0, 0.0069941871757909875, 0, 0.9999755403737384]], [[2, 15, 1], [-74.84897633854992, 7.5, 18.73006592825067], [0, 0.11263413488003804, 0, 0.9936365289479979]], [[2, 15, 1], [-73.20706469537453, 7.5, 23.20164447462955], [0, 0.22383740912672334, 0, 0.9746264998836405]], [[2, 15, 1], [-71.18203193338566, 7.5, 26.292234560854716], [0, 0.3115794818148594, 0, 0.9502200937214408]], [[2, 15, 1], [-69.54578750228563, 7.5, 28.184249518783183], [0, 0.32775782640322976, 0, 0.9447617727403191]], [[2, 15, 1], [-68.5624618001197, 7.5, 29.613297246788672], [0, 0.26019149285166326, 0, 0.965557034590719]], [[2, 15, 1], [-67.75805642289954, 7.5, 31.260465255868468], [0, 0.2816392436595326, 0, 0.9595203679083036]], [[2, 15, 1], [-66.260769764402, 7.5, 33.196332059724725], [0, 0.42684551604949916, 0, 0.9043245575723556]], [[2, 15, 1], [-63.4501127109768, 7.5, 34.8072336952555], [0, 0.5963563282264503, 0, 0.8027198326840231]], [[2, 15, 1], [-59.414105601962966, 7.5, 35.26101541096545], [-0, 0.7335136220015339, 0, 0.6796747504050675]], [[2, 15, 1], [-54.86225638093425, 7.5, 34.15193174691563], [-0, 0.8251784495954215, 0, 0.5648721327196948]], [[2, 15, 1], [-50.56287249692535, 7.5, 31.82550659917896], [-0, 0.8734501905769223, 0, 0.4869135083165568]], [[2, 15, 1], [-46.74104260392785, 7.5, 29.131434550572305], [-0, 0.8800575730298058, 0, 0.47486700048844005]], [[2, 15, 1], [-42.90387419559153, 7.5, 26.79474943783817], [-0, 0.8502756206198967, 0, 0.5263376948114674]], [[2, 15, 1], [-38.22889795669297, 7.5, 24.89052938162219], [-0, 0.8209781821494251, 0, 0.5709595646231223]], [[2, 15, 1], [-32.215721768074644, 7.5, 22.827149849508373], [-0, 0.8241280913879445, 0, 0.5664034683732645]], [[2, 15, 1], [-25.0971428901263, 7.5, 19.849619664771506], [-0, 0.849092659480846, 0, 0.528243935711281]], [[2, 15, 1], [-17.691704371487848, 7.5, 15.672184066568938], [-0, 0.876717823787797, 0, 0.4810050493007216]], [[2, 15, 1], [-10.811427475718572, 7.5, 10.749361094558557], [-0, 0.8937739029474104, 0, 0.44851779274645637]], [[2, 15, 1], [-4.682234210353201, 7.5, 5.9742537527180435], [-0, 0.8910600227356793, 0, 0.4538854876312867]], [[2, 15, 1], [1.1755021061036184, 7.5, 2.036029372175641], [-0, 0.8660254037844385, 0, 0.5000000000000001]], [[2, 15, 1], [7.51497262368497, 7.5, -1.0678068962754328], [-0, 0.8386063740656214, 0, 0.5447378721701943]], [[2, 15, 1], [14.71493352019912, 7.5, -3.9882902978660852], [-0, 0.83531475404146, 0, 0.5497720088187964]], [[2, 15, 1], [22.418361720178364, 7.5, -7.485373388668233], [-0, 0.8549215039369099, 0, 0.5187573827004802]], [[2, 15, 1], [29.738846330214447, 7.5, -11.809953472871644], [-0, 0.8820189974614663, 0, 0.47121384542166184]], [[2, 15, 1], [35.8767525497057, 7.5, -16.486058527649796], [-0, 0.9025838380968352, 0, 0.4305141289277113]], [[2, 15, 1], [40.67027973647428, 7.5, -20.661932098368034], [-0, 0.9049545785720394, 0, 0.42550817938260904]], [[2, 15, 1], [44.65687079900243, 7.5, -23.758470255234833], [-0, 0.8809596249860203, 0, 0.47319144026967613]], [[2, 15, 1], [48.599083671443246, 7.5, -25.91321301908612], [-0, 0.8512756723568095, 0, 0.5247187147924702]], [[2, 15, 1], [52.84313345166094, 7.5, -27.875978771061398], [-0, 0.8584045629364053, 0, 0.5129732998216955]], [[2, 15, 1], [57.00756867160831, 7.5, -30.436141861366174], [-0, 0.9017828416228612, 0, 0.43218943364524465]], [[2, 15, 1], [60.24398791011213, 7.5, -33.82361708894854], [-0, 0.9553724111624028, 0, 0.2954040554727314]], [[2, 15, 1], [61.86900497104135, 7.5, -37.545792633064075], [-0, 0.9933539313391836, 0, 0.11509981360970586]], [[2, 15, 1], [61.8792517583864, 7.5, -40.785343860421605], [-0, -0.9965907981485324, 0, 0.08250321839583227]], [[2, 15, 1], [60.95138525715268, 7.5, -43.04996554535614], [-0, -0.9717886358869489, 0, 0.23585344424235852]], [[2, 15, 1], [59.92709860559863, 7.5, -44.57018504150951], [-0, -0.9662926671841633, 0, 0.2574460746372235]], [[2, 15, 1], [59.181169821008375, 7.5, -46.13629394378211], [-0, -0.9820666089191517, 0, 0.1885342824157949]], [[2, 15, 1], [58.36075901865219, 7.5, -48.4993306668798], [-0, -0.9787044812566277, 0, 0.20527430031106075]], [[2, 15, 1], [56.69674587229129, 7.5, -51.79835552537049], [-0, -0.9559700126641055, 0, 0.2934643673207874]], [[2, 15, 1], [53.64520107769738, 7.5, -55.45608199231927], [-0, -0.9168315436371769, 0, 0.39927424233460307]], [[2, 15, 1], [49.361528321687686, 7.5, -58.622864358227844], [-0, -0.8695013147146242, 0, 0.49393062641381147]], [[2, 15, 1], [44.63906814855532, 7.5, -60.825130312844124], [-0, -0.830525227846717, 0, 0.5569810103676415]], [[2, 15, 1], [40.35805294025956, 7.5, -62.31646086659971], [-0, -0.8257761869189767, 0, 0.5639979513416297]], [[2, 15, 1], [36.86945581158719, 7.5, -63.859770713084615], [-0, -0.8660254037844386, 0, 0.5000000000000001]], [[2, 15, 1], [33.78861171428441, 7.5, -66.10932952684189], [-0, -0.9013246470037196, 0, 0.4331441800412655]], [[2, 15, 1], [30.356573965144296, 7.5, -69.07113217433574], [-0, -0.8976223183272598, 0, 0.440765440615295]], [[2, 15, 1], [26.08812561599081, 7.5, -72.05976967532051], [-0, -0.8625071275388341, 0, 0.506044913959927]], [[2, 15, 1], [21.20377526085255, 7.5, -74.18614792056991], [-0, -0.8041974087571386, 0, 0.5943622866133952]], [[2, 15, 1], [16.51031882308326, 7.5, -75], [-0, -0.7321326035373825, 0, 0.6811621325628531]], [[2, 15, 1], [12.8212729147335, 7.5, -74.79156522773448], [0, -0.6671249994417694, 0, 0.744945793410379]], [[2, 15, 1], [10.364617681277267, 7.5, -74.32054346256527], [0, -0.6543087825159226, 0, 0.7562274903245261]], [[2, 15, 1], [8.635363194521116, 7.5, -74.18348228829817], [0, -0.7061011743325019, 0, 0.7081109599534962]], [[2, 15, 1], [6.806671165746897, 7.5, -74.3104308012246], [0, -0.6901493922274156, 0, 0.7236669236659423]], [[2, 15, 1], [4.3815180060156065, 7.5, -73.98167592014633], [0, -0.569745282099032, 0, 0.8218213391765234]], [[2, 15, 1], [1.5811077399354532, 7.5, -72.35302632831956], [0, -0.39699760311273397, 0, 0.9178196462937281]], [[2, 15, 1], [-0.8298823081491635, 7.5, -69.084632499914], [0, -0.22185878916086965, 0, 0.9750788058777982]], [[2, 15, 1], [-2.1453122906740556, 7.5, -64.5880736082818], [0, -0.07660439202743978, 0, 0.9970615663649394]], [[2, 15, 1], [-2.280260954735577, 7.5, -59.70148537024036], [0, 0.015045627640517551, 0, 0.9998868081382527]], [[2, 15, 1], [-1.8580410675153844, 7.5, -55.04464756965841], [0, 0.028781900672996016, 0, 0.9995857152809107]], [[2, 15, 1], [-1.752996603410883, 7.5, -50.55321969307299], [0, -0.03068400436612373, 0, 0.9995291350811439]], [[2, 15, 1], [-2.441381779781297, 7.5, -45.55246147999022], [0, -0.08397639642261429, 0, 0.9964677440057315]], [[2, 15, 1], [-3.6610307816310397, 7.5, -39.313208377158155], [0, -0.07845574670889054, 0, 0.9969175973009757]], [[2, 15, 1], [-4.641703440088112, 7.5, -31.659573137643136], [0, -0.03292633798062029, 0, 0.9994577811329431]], [[2, 15, 1], [-4.726657348690474, 7.5, -23.157557455237153], [0, 0.021796319850886977, 0, 0.9997624320012019]], [[2, 15, 1], [-3.9035060444805167, 7.5, -14.737651392424628], [0, 0.05845914890594999, 0, 0.9982898015652529]], [[2, 15, 1], [-2.832738413331729, 7.5, -7.042060648993457], [0, 0.05245364867005808, 0, 0.998623359801481]], [[2, 15, 1], [-2.351004212207177, 7.5, 7.306735909018943E-15], [0, 2.2170373221683047E-16, 0, 1]], [[2, 15, 1], [-2.8327384133317226, 7.5, 7.042060648993472], [0, -0.0524536486700576, 0, 0.998623359801481]], [[2, 15, 1], [-3.903506044480504, 7.5, 14.737651392424656], [0, -0.058459148905949276, 0, 0.9982898015652529]], [[2, 15, 1], [-4.7266573486904475, 7.5, 23.157557455237193], [0, -0.021796319850886675, 0, 0.9997624320012019]]]
})

// one body - one mesh
const objects = [
    ...boxComposer.getObjects()
];

world.init(objects);

document.getElementById("btnBum").addEventListener("click", event => { 
    const objects = world.getInstancesOf(PBox).filter(o=>o.upFactor > 0.5)
    if (objects.length > 0) {
        const force = 10000 * (1 + Math.random())
        const i = Math.trunc((objects.length - 1) * Math.random())
        const f = new CANNON.Vec3(0, 0, force)
        const q = objects[i].body.quaternion
        const qF = q.vmult(f)
        objects[i].body.applyForce(qF)
    } else {
        world.getInstancesOf(PBox).forEach(o => {
            o.body.applyForce(new CANNON.Vec3(0, 100000*Math.random(), 0))
            o.body.applyTorque(new CANNON.Vec3(1000*Math.random(), 1000*Math.random(), 1000*Math.random()))
        })
    }
});

// Animation loop
function animate() {
    world.update();
    requestAnimationFrame(animate);
}

animate();
